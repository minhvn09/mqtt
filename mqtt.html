<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MQTT Web Client</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            text-align: center;
            color: #4a4a4a;
        }
        #status {
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        .status-connecting {
            background-color: #e0e0e0;
            color: #333;
        }
        .status-connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .input-group {
            display: flex;
            margin-bottom: 15px;
        }
        .input-group input {
            flex-grow: 1;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-right: 10px;
        }
        .input-group button {
            padding: 10px 15px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        .input-group button:hover {
            background-color: #0056b3;
        }
        #messages {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: scroll;
            background-color: #fafafa;
            border-radius: 5px;
        }
        .message {
            margin-bottom: 5px;
            padding: 5px;
            background-color: #e9e9e9;
            border-radius: 3px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>MQTT Web Client</h1>
    <div id="status" class="status-connecting">ƒêang k·∫øt n·ªëi...</div>

    <div class="input-group">
        <input type="text" id="topicInput" placeholder="Nh·∫≠p t√™n topic..." value="minhvn">
        <button id="subscribeBtn">ƒêƒÉng k√Ω Topic</button>
    </div>

    <div class="input-group">
        <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." disabled>
        <button id="sendBtn" disabled>G·ª≠i</button>
    </div>

    <h2>Nh·∫≠t k√Ω tin nh·∫Øn</h2>
    <div id="messages"></div>
</div>

<script>
    const statusDiv = document.getElementById('status');
    const topicInput = document.getElementById('topicInput');
    const subscribeBtn = document.getElementById('subscribeBtn');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const messagesDiv = document.getElementById('messages');

    const brokerUrl = 'wss://broker.emqx.io:8084/mqtt';
    const clientId = 'mqtt_js_' + Math.random().toString(16).substr(2, 8);
    
    let currentTopic = '';
    let client = null;

    function updateStatus(text, className) {
        statusDiv.textContent = text;
        statusDiv.className = '';
        statusDiv.classList.add(className);
    }

    function requestNotificationPermission() {
        if (!("Notification" in window)) {
            console.warn("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ th√¥ng b√°o.");
            return;
        }
        
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                console.log("ƒê√£ ƒë∆∞·ª£c c·∫•p quy·ªÅn g·ª≠i th√¥ng b√°o.");
            } else if (permission === "denied") {
                console.log("Quy·ªÅn g·ª≠i th√¥ng b√°o b·ªã t·ª´ ch·ªëi.");
            }
        });
    }

    function connectToBroker() {
        if (client) {
            client.end();
        }
        
        updateStatus('ƒêang k·∫øt n·ªëi...', 'status-connecting');
        client = mqtt.connect(brokerUrl, { clientId: clientId });

        client.on('connect', () => {
            updateStatus('‚úÖ ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng!', 'status-connected');
            messageInput.disabled = false;
            sendBtn.disabled = false;
            subscribeToTopic(topicInput.value);
        });

        client.on('error', (err) => {
            console.error('L·ªói k·∫øt n·ªëi:', err);
            updateStatus('‚ùå L·ªói k·∫øt n·ªëi!', 'status-error');
            messageInput.disabled = true;
            sendBtn.disabled = true;
        });

        client.on('close', () => {
            updateStatus('üîå M·∫•t k·∫øt n·ªëi! ƒêang th·ª≠ l·∫°i...', 'status-error');
            setTimeout(connectToBroker, 3000); // t·ª± reconnect
        });

        client.on('message', (receivedTopic, message) => {
            const msg = message.toString();

            // lu√¥n hi·ªÉn th·ªã nh·∫≠t k√Ω tr∆∞·ªõc
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.textContent = `[${receivedTopic}] ${msg}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // th·ª≠ g·ª≠i Notification, n·∫øu l·ªói th√¨ b·ªè qua
            if (Notification.permission === "granted") {
                try {
                    new Notification(`Tin nh·∫Øn m·ªõi t·ª´ ${receivedTopic}`, {
                        body: msg,
                        icon: 'https://cdn-icons-png.flaticon.com/512/869/869636.png'
                    });
                } catch (err) {
                    console.warn("Kh√¥ng g·ª≠i ƒë∆∞·ª£c Notification:", err);
                }
            }
        });
    }

    function subscribeToTopic(topic) {
        if (client && client.connected) {
            if (currentTopic) {
                client.unsubscribe(currentTopic, (err) => {
                    if (!err) {
                        console.log(`ƒê√£ h·ªßy ƒëƒÉng k√Ω topic: ${currentTopic}`);
                    }
                });
            }
            
            client.subscribe(topic, (err) => {
                if (!err) {
                    currentTopic = topic;
                    console.log(`ƒê√£ ƒëƒÉng k√Ω topic m·ªõi: ${currentTopic}`);
                } else {
                    console.error('L·ªói khi ƒëƒÉng k√Ω:', err);
                }
            });
        }
    }

    subscribeBtn.addEventListener('click', () => {
        const newTopic = topicInput.value.trim();
        if (newTopic) {
            subscribeToTopic(newTopic);
        } else {
            alert('Vui l√≤ng nh·∫≠p t√™n topic.');
        }
    });

    sendBtn.addEventListener('click', () => {
        const message = messageInput.value.trim();
        if (message && currentTopic) {
            client.publish(currentTopic, message, (err) => {
                if (err) {
                    console.error('L·ªói khi g·ª≠i tin nh·∫Øn:', err);
                } else {
                    console.log(`ƒê√£ g·ª≠i tin nh·∫Øn: ${message}`);
                    messageInput.value = '';
                }
            });
        }
    });

    // B·∫Øt ƒë·∫ßu khi t·∫£i trang
    requestNotificationPermission();
    connectToBroker();
</script>

</body>
</html>